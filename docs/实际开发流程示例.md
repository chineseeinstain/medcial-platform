# å®é™…å¼€å‘æµç¨‹ç¤ºä¾‹ - ä»éœ€æ±‚åˆ°å®ç°

## ğŸ¯ ç¤ºä¾‹ï¼šå®ç°"é—¨è¯Šé‡è¶‹åŠ¿åˆ†æ"åŠŸèƒ½

æœ¬æ–‡æ¡£é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„åŠŸèƒ½å¼€å‘æµç¨‹ï¼Œå±•ç¤ºå¦‚ä½•ä»éœ€æ±‚åˆ†æåˆ°ä»£ç å®ç°çš„å®Œæ•´è¿‡ç¨‹ã€‚

---

## ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šéœ€æ±‚åˆ†æ

### éœ€æ±‚æè¿°
ç”¨æˆ·éœ€è¦æŸ¥çœ‹æœ€è¿‘30å¤©çš„é—¨è¯Šé‡è¶‹åŠ¿ï¼Œä»¥æŠ˜çº¿å›¾å½¢å¼å±•ç¤ºã€‚

### éœ€æ±‚æ‹†è§£
1. **æ•°æ®æ¥æº**ï¼šæ‚£è€…å°±è¯Šè®°å½•è¡¨ï¼ˆpatient_visitï¼‰
2. **ç»Ÿè®¡ç»´åº¦**ï¼šæŒ‰æ—¥æœŸç»Ÿè®¡æ¯æ—¥é—¨è¯Šé‡
3. **æ—¶é—´èŒƒå›´**ï¼šæœ€è¿‘30å¤©
4. **å±•ç¤ºæ–¹å¼**ï¼šæŠ˜çº¿å›¾ï¼ˆå‰ç«¯EChartsï¼‰

---

## ğŸ—„ï¸ ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“è®¾è®¡

### æ•°æ®è¡¨ç»“æ„ï¼ˆå‡è®¾å·²å­˜åœ¨ï¼‰

```sql
-- æ‚£è€…å°±è¯Šè®°å½•è¡¨
CREATE TABLE patient_visit (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    patient_id VARCHAR(50) COMMENT 'æ‚£è€…IDï¼ˆè„±æ•åï¼‰',
    visit_date DATE COMMENT 'å°±è¯Šæ—¥æœŸ',
    department VARCHAR(50) COMMENT 'ç§‘å®¤',
    diagnosis VARCHAR(200) COMMENT 'è¯Šæ–­',
    cost DECIMAL(10,2) COMMENT 'è´¹ç”¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO patient_visit (patient_id, visit_date, department, diagnosis, cost) VALUES
('P001', '2024-01-01', 'å†…ç§‘', 'æ„Ÿå†’', 50.00),
('P002', '2024-01-01', 'å¤–ç§‘', 'å¤–ä¼¤', 100.00),
('P003', '2024-01-02', 'å†…ç§‘', 'é«˜è¡€å‹', 80.00);
```

### SQLæŸ¥è¯¢è¯­å¥è®¾è®¡

```sql
-- æŸ¥è¯¢æœ€è¿‘30å¤©çš„é—¨è¯Šé‡è¶‹åŠ¿
SELECT 
    DATE(visit_date) as date,           -- æ—¥æœŸ
    COUNT(*) as count                   -- æ¯æ—¥é—¨è¯Šé‡
FROM patient_visit
WHERE visit_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)  -- æœ€è¿‘30å¤©
GROUP BY DATE(visit_date)               -- æŒ‰æ—¥æœŸåˆ†ç»„
ORDER BY date ASC;                      -- æŒ‰æ—¥æœŸæ’åº
```

**é¢„æœŸç»“æœ**ï¼š
```
date       | count
-----------|------
2024-01-01 | 2
2024-01-02 | 1
2024-01-03 | 3
...
```

---

## ğŸ’» ç¬¬ä¸‰æ­¥ï¼šåç«¯å¼€å‘

### 3.1 åˆ›å»ºDTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰

```java
// backend/src/main/java/com/medical/dto/TrendDataDTO.java
package com.medical.dto;

import lombok.Data;
import java.util.Date;

/**
 * è¶‹åŠ¿æ•°æ®DTO
 * ç”¨äºè¿”å›ç»™å‰ç«¯çš„ç»Ÿè®¡æ•°æ®
 */
@Data
public class TrendDataDTO {
    private Date date;      // æ—¥æœŸ
    private Integer count;  // æ•°é‡
}
```

### 3.2 åˆ›å»ºMapperæ¥å£

```java
// backend/src/main/java/com/medical/mapper/StatisticsMapper.java
package com.medical.mapper;

import com.medical.dto.TrendDataDTO;
import org.apache.ibatis.annotations.Mapper;
import java.util.List;

@Mapper
public interface StatisticsMapper {
    /**
     * æŸ¥è¯¢é—¨è¯Šé‡è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰
     */
    List<TrendDataDTO> selectOutpatientTrend();
}
```

### 3.3 åˆ›å»ºMapper XMLæ–‡ä»¶

```xml
<!-- backend/src/main/resources/mapper/StatisticsMapper.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medical.mapper.StatisticsMapper">
    
    <!-- æŸ¥è¯¢é—¨è¯Šé‡è¶‹åŠ¿ -->
    <select id="selectOutpatientTrend" resultType="com.medical.dto.TrendDataDTO">
        SELECT 
            DATE(visit_date) as date,
            COUNT(*) as count
        FROM patient_visit
        WHERE visit_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        GROUP BY DATE(visit_date)
        ORDER BY date ASC
    </select>
    
</mapper>
```

### 3.4 åˆ›å»ºServiceå±‚

```java
// backend/src/main/java/com/medical/service/StatisticsService.java
package com.medical.service;

import com.medical.dto.TrendDataDTO;
import com.medical.mapper.StatisticsMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.concurrent.TimeUnit;

@Service
@Slf4j
public class StatisticsService {
    
    @Autowired
    private StatisticsMapper statisticsMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * è·å–é—¨è¯Šé‡è¶‹åŠ¿æ•°æ®
     * 
     * æµç¨‹ï¼š
     * 1. å…ˆæŸ¥Redisç¼“å­˜
     * 2. ç¼“å­˜æ²¡æœ‰ â†’ æŸ¥æ•°æ®åº“
     * 3. å­˜å…¥Redisç¼“å­˜ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
     */
    public List<TrendDataDTO> getOutpatientTrend() {
        String cacheKey = "statistics:outpatient-trend";
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        @SuppressWarnings("unchecked")
        List<TrendDataDTO> cached = (List<TrendDataDTO>) redisTemplate.opsForValue().get(cacheKey);
        
        if (cached != null) {
            log.info("ä»Redisç¼“å­˜è·å–é—¨è¯Šé‡è¶‹åŠ¿æ•°æ®");
            return cached;
        }
        
        // 2. ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥æ•°æ®åº“
        log.info("ä»æ•°æ®åº“æŸ¥è¯¢é—¨è¯Šé‡è¶‹åŠ¿æ•°æ®");
        List<TrendDataDTO> data = statisticsMapper.selectOutpatientTrend();
        
        // 3. å­˜å…¥ç¼“å­˜ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
        redisTemplate.opsForValue().set(cacheKey, data, 5, TimeUnit.MINUTES);
        
        return data;
    }
}
```

### 3.5 åˆ›å»ºControllerå±‚

```java
// backend/src/main/java/com/medical/controller/StatisticsController.java
package com.medical.controller;

import com.medical.common.Result;
import com.medical.dto.TrendDataDTO;
import com.medical.service.StatisticsService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("/api/statistics")
@Slf4j
public class StatisticsController {
    
    @Autowired
    private StatisticsService statisticsService;
    
    /**
     * è·å–é—¨è¯Šé‡è¶‹åŠ¿
     * GET /api/statistics/outpatient-trend
     */
    @GetMapping("/outpatient-trend")
    public Result<List<TrendDataDTO>> getOutpatientTrend() {
        log.info("æŸ¥è¯¢é—¨è¯Šé‡è¶‹åŠ¿");
        List<TrendDataDTO> data = statisticsService.getOutpatientTrend();
        return Result.success(data);
    }
}
```

---

## ğŸ¨ ç¬¬å››æ­¥ï¼šå‰ç«¯å¼€å‘

### 4.1 åˆ›å»ºAPIè¯·æ±‚å°è£…

```javascript
// frontend/src/api/statistics.js
import request from './request'

/**
 * è·å–é—¨è¯Šé‡è¶‹åŠ¿æ•°æ®
 */
export function getOutpatientTrend() {
  return request({
    url: '/api/statistics/outpatient-trend',
    method: 'get'
  })
}
```

### 4.2 åˆ›å»ºé¡µé¢ç»„ä»¶

```vue
<!-- frontend/src/views/statistics/OutpatientTrend.vue -->
<template>
  <div class="outpatient-trend">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>é—¨è¯Šé‡è¶‹åŠ¿åˆ†æ</span>
          <el-button type="primary" @click="refreshData">åˆ·æ–°</el-button>
        </div>
      </template>
      
      <!-- EChartså›¾è¡¨å®¹å™¨ -->
      <div ref="chartContainer" style="width: 100%; height: 400px;"></div>
    </el-card>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'
import * as echarts from 'echarts'
import { getOutpatientTrend } from '@/api/statistics'

// å›¾è¡¨å®¹å™¨å¼•ç”¨
const chartContainer = ref(null)
let chartInstance = null

// åŠ è½½æ•°æ®å¹¶æ¸²æŸ“å›¾è¡¨
const loadData = async () => {
  try {
    // 1. è°ƒç”¨APIè·å–æ•°æ®
    const response = await getOutpatientTrend()
    const data = response.data
    
    // 2. å¤„ç†æ•°æ®æ ¼å¼ï¼ˆé€‚é…EChartsï¼‰
    const dates = data.map(item => {
      // æ ¼å¼åŒ–æ—¥æœŸï¼š2024-01-01 -> 01-01
      const date = new Date(item.date)
      return `${date.getMonth() + 1}-${date.getDate()}`
    })
    const counts = data.map(item => item.count)
    
    // 3. é…ç½®å›¾è¡¨
    const option = {
      title: {
        text: 'æœ€è¿‘30å¤©é—¨è¯Šé‡è¶‹åŠ¿',
        left: 'center'
      },
      tooltip: {
        trigger: 'axis',
        formatter: function(params) {
          return `${params[0].name}<br/>é—¨è¯Šé‡: ${params[0].value}äººæ¬¡`
        }
      },
      xAxis: {
        type: 'category',
        data: dates,
        name: 'æ—¥æœŸ'
      },
      yAxis: {
        type: 'value',
        name: 'é—¨è¯Šé‡ï¼ˆäººæ¬¡ï¼‰'
      },
      series: [{
        name: 'é—¨è¯Šé‡',
        type: 'line',
        data: counts,
        smooth: true,  // å¹³æ»‘æ›²çº¿
        itemStyle: {
          color: '#409EFF'  // è“è‰²
        },
        areaStyle: {
          color: {
            type: 'linear',
            x: 0,
            y: 0,
            x2: 0,
            y2: 1,
            colorStops: [{
              offset: 0, color: 'rgba(64, 158, 255, 0.3)'
            }, {
              offset: 1, color: 'rgba(64, 158, 255, 0.1)'
            }]
          }
        }
      }]
    }
    
    // 4. æ¸²æŸ“å›¾è¡¨
    if (!chartInstance) {
      chartInstance = echarts.init(chartContainer.value)
    }
    chartInstance.setOption(option)
    
  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥')
  }
}

// åˆ·æ–°æ•°æ®
const refreshData = () => {
  loadData()
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
onMounted(() => {
  loadData()
  
  // çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œé‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
  window.addEventListener('resize', () => {
    if (chartInstance) {
      chartInstance.resize()
    }
  })
})

// é¡µé¢å¸è½½æ—¶é”€æ¯å›¾è¡¨
onUnmounted(() => {
  if (chartInstance) {
    chartInstance.dispose()
  }
})
</script>

<style scoped>
.outpatient-trend {
  padding: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
</style>
```

### 4.3 é…ç½®è·¯ç”±

```javascript
// frontend/src/router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import OutpatientTrend from '@/views/statistics/OutpatientTrend.vue'

const routes = [
  {
    path: '/statistics/outpatient-trend',
    name: 'OutpatientTrend',
    component: OutpatientTrend
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

export default router
```

---

## ğŸ§ª ç¬¬äº”æ­¥ï¼šæµ‹è¯•

### 5.1 åç«¯APIæµ‹è¯•ï¼ˆPostmanï¼‰

**è¯·æ±‚**ï¼š
```
GET http://localhost:8080/api/statistics/outpatient-trend
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": [
    {
      "date": "2024-01-01",
      "count": 2
    },
    {
      "date": "2024-01-02",
      "count": 1
    },
    {
      "date": "2024-01-03",
      "count": 3
    }
  ]
}
```

### 5.2 å‰ç«¯åŠŸèƒ½æµ‹è¯•

1. å¯åŠ¨å‰ç«¯ï¼š`npm run dev`
2. è®¿é—®ï¼š`http://localhost:3000/statistics/outpatient-trend`
3. æ£€æŸ¥å›¾è¡¨æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
4. æµ‹è¯•åˆ·æ–°åŠŸèƒ½

---

## ğŸ”„ ç¬¬å…­æ­¥ï¼šå®Œæ•´æ•°æ®æµè½¬è¿‡ç¨‹

### æµç¨‹å›¾

```
ç”¨æˆ·æ“ä½œ
  â†“
ç‚¹å‡»"é—¨è¯Šé‡è¶‹åŠ¿"èœå•
  â†“
å‰ç«¯è·¯ç”±è·³è½¬
  â†“
Vueç»„ä»¶åŠ è½½ï¼ˆOutpatientTrend.vueï¼‰
  â†“
onMountedé’©å­æ‰§è¡Œ
  â†“
è°ƒç”¨ getOutpatientTrend() API
  â†“
å‘é€HTTPè¯·æ±‚ï¼šGET /api/statistics/outpatient-trend
  â†“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åç«¯å¤„ç†
  â†“
StatisticsControlleræ¥æ”¶è¯·æ±‚
  â†“
è°ƒç”¨ StatisticsService.getOutpatientTrend()
  â†“
Serviceå±‚å¤„ç†ï¼š
  1. æŸ¥Redisç¼“å­˜ï¼ˆcacheKey: "statistics:outpatient-trend"ï¼‰
  2. ç¼“å­˜æ²¡æœ‰ â†’ è°ƒç”¨ StatisticsMapper.selectOutpatientTrend()
  3. Mapperæ‰§è¡ŒSQLæŸ¥è¯¢MySQL
  4. ç»“æœå­˜å…¥Redisï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
  â†“
è¿”å› List<TrendDataDTO>
  â†“
Controllerè¿”å› Result.success(data)
  â†“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¿”å›JSONå“åº”
  â†“
å‰ç«¯æ¥æ”¶æ•°æ®
  â†“
å¤„ç†æ•°æ®æ ¼å¼ï¼ˆé€‚é…EChartsï¼‰
  â†“
EChartsæ¸²æŸ“æŠ˜çº¿å›¾
  â†“
ç”¨æˆ·çœ‹åˆ°å›¾è¡¨
```

---

## ğŸ“Š ç¬¬ä¸ƒæ­¥ï¼šæ€§èƒ½ä¼˜åŒ–

### 7.1 Redisç¼“å­˜ä¼˜åŒ–

**å½“å‰å®ç°**ï¼š5åˆ†é’Ÿè¿‡æœŸ

**ä¼˜åŒ–å»ºè®®**ï¼š
- æ•°æ®æ›´æ–°æ—¶ä¸»åŠ¨æ¸…é™¤ç¼“å­˜
- ä½¿ç”¨æ›´ç»†ç²’åº¦çš„ç¼“å­˜keyï¼ˆå¦‚æŒ‰æ—¥æœŸï¼‰

### 7.2 æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**ï¼š
```sql
-- ä¸ºvisit_dateå­—æ®µæ·»åŠ ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦
CREATE INDEX idx_visit_date ON patient_visit(visit_date);
```

### 7.3 å‰ç«¯ä¼˜åŒ–

**å›¾è¡¨ä¼˜åŒ–**ï¼š
- å¤§æ•°æ®é‡æ—¶é‡‡æ ·æ˜¾ç¤º
- ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼‰

---

## ğŸ› ç¬¬å…«æ­¥ï¼šå¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šå›¾è¡¨ä¸æ˜¾ç¤º

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥APIæ˜¯å¦è¿”å›æ•°æ®ï¼ˆæµè§ˆå™¨Networké¢æ¿ï¼‰
2. æ£€æŸ¥EChartså®¹å™¨æ˜¯å¦æœ‰é«˜åº¦
3. æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®

### é—®é¢˜2ï¼šæ•°æ®ä¸æ›´æ–°

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥Redisç¼“å­˜æ˜¯å¦è¿‡æœŸ
2. æ£€æŸ¥æ•°æ®åº“æ•°æ®æ˜¯å¦æ›´æ–°
3. æ¸…é™¤Redisç¼“å­˜æµ‹è¯•

### é—®é¢˜3ï¼šAPIè¿”å›404

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥APIè·¯å¾„æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥Controlleræ˜¯å¦æ·»åŠ äº†@RestControlleræ³¨è§£

---

## âœ… æ€»ç»“

### å¼€å‘æµç¨‹æ€»ç»“

```
1. éœ€æ±‚åˆ†æ â†’ æ˜ç¡®è¦åšä»€ä¹ˆ
2. æ•°æ®åº“è®¾è®¡ â†’ è®¾è®¡SQLæŸ¥è¯¢
3. åç«¯å¼€å‘ â†’ Mapper â†’ Service â†’ Controller
4. å‰ç«¯å¼€å‘ â†’ APIå°è£… â†’ é¡µé¢ç»„ä»¶ â†’ å›¾è¡¨æ¸²æŸ“
5. æµ‹è¯• â†’ APIæµ‹è¯• â†’ åŠŸèƒ½æµ‹è¯•
6. ä¼˜åŒ– â†’ æ€§èƒ½ä¼˜åŒ– â†’ ä½“éªŒä¼˜åŒ–
```

### å…³é”®ç‚¹

1. **åˆ†å±‚æ¸…æ™°**ï¼šController â†’ Service â†’ Mapper
2. **ç¼“å­˜ç­–ç•¥**ï¼šRedisç¼“å­˜çƒ­ç‚¹æ•°æ®
3. **æ•°æ®æ ¼å¼**ï¼šå‰åç«¯ç»Ÿä¸€æ•°æ®æ ¼å¼
4. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

---

**é€šè¿‡è¿™ä¸ªç¤ºä¾‹ï¼Œä½ åº”è¯¥ç†è§£äº†ï¼š**
- å¦‚ä½•ä»éœ€æ±‚åˆ°å®ç°
- åç«¯ä¸‰å±‚æ¶æ„å¦‚ä½•é…åˆ
- å‰åç«¯å¦‚ä½•äº¤äº’
- å¦‚ä½•ä¼˜åŒ–æ€§èƒ½

**ä¸‹ä¸€æ­¥**ï¼šå°è¯•å®ç°å…¶ä»–åŠŸèƒ½ï¼Œå¦‚"åŒ»ä¿æ§è´¹åˆ†æ"ã€"è®¾å¤‡ä½¿ç”¨ç‡åˆ†æ"ç­‰ï¼

