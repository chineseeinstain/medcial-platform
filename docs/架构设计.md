# 系统架构设计文档

## 一、整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Vue 3)                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 登录模块 │  │ 数据看板 │  │ 分析报告 │  │ 系统管理 │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
│       │              │              │              │         │
│       └──────────────┴──────────────┴──────────────┘         │
│                          │ HTTP/HTTPS                          │
└──────────────────────────┼────────────────────────────────────┘
                           │
┌──────────────────────────┼────────────────────────────────────┐
│                   后端层 (Spring Boot)                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          Spring Security (权限认证)                   │   │
│  └──────────────────────────────────────────────────────┘   │
│                          │                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Controller  │→ │   Service    │→ │    Mapper    │      │
│  │   (API层)    │  │  (业务逻辑)   │  │  (数据访问)   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│         │                 │                    │             │
│         └─────────────────┴────────────────────┘             │
│                          │                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │    Redis     │  │   Python     │  │   Hadoop     │      │
│  │   (缓存)     │  │  (分析脚本)   │  │  (大数据)    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└──────────────────────────┼────────────────────────────────────┘
                           │
┌──────────────────────────┼────────────────────────────────────┐
│                     数据层                                      │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              MySQL (业务数据库)                       │   │
│  │  - 患者诊疗表  - 科室运营表  - 医保结算表             │   │
│  │  - 设备使用表  - 药品库存表  - 人员信息表             │   │
│  │  ... (共12张主题表)                                   │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         Hadoop HDFS (大数据存储)                      │   │
│  │  - 历史数据归档  - 批量处理数据                        │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 二、技术选型理由

### 2.1 后端技术栈

| 技术 | 作用 | 为什么选择 |
|------|------|-----------|
| **Java** | 编程语言 | 企业级应用标准，生态成熟，跨平台 |
| **Spring Boot** | 框架 | 快速开发，自动配置，内置服务器 |
| **MyBatis** | ORM框架 | 灵活，SQL可控，适合复杂查询 |
| **MySQL** | 关系数据库 | 成熟稳定，事务支持，适合业务数据 |
| **Redis** | 缓存 | 高性能，减少数据库压力 |
| **Hadoop** | 大数据处理 | 分布式处理，适合批量ETL |
| **Spring Security** | 安全框架 | 完善的权限控制，JWT支持 |

### 2.2 前端技术栈

| 技术 | 作用 | 为什么选择 |
|------|------|-----------|
| **Vue 3** | 前端框架 | 组件化，响应式，易学易用 |
| **Vite** | 构建工具 | 开发快，构建优化好 |
| **ECharts** | 图表库 | 功能强大，支持钻取 |
| **Element Plus** | UI组件 | 现成组件，开发效率高 |
| **Axios** | HTTP客户端 | 请求拦截，响应处理 |

### 2.3 分析工具

| 技术 | 作用 | 为什么选择 |
|------|------|-----------|
| **Python** | 脚本语言 | 数据分析生态丰富 |
| **Pandas** | 数据处理 | 表格处理方便，性能好 |
| **NumPy** | 数值计算 | 科学计算标准库 |
| **SQL** | 查询语言 | 数据库原生，聚合统计 |

## 三、数据流设计

### 3.1 用户查询数据流程

```
1. 用户在前端点击查询
   ↓
2. Vue组件发送HTTP请求 (Axios)
   ↓
3. Spring Boot Controller接收请求
   ↓
4. Spring Security验证Token和权限
   ↓
5. Controller调用Service层
   ↓
6. Service先查Redis缓存
   ├─ 有缓存 → 直接返回
   └─ 无缓存 → 继续
   ↓
7. Service调用Mapper查询MySQL
   ↓
8. 数据返回Service → Controller → JSON响应
   ↓
9. 前端接收数据，ECharts渲染图表
```

### 3.2 数据分析报告生成流程

```
1. 用户请求生成分析报告
   ↓
2. 后端接收请求，验证权限
   ↓
3. Service从MySQL读取原始数据
   ↓
4. 调用Python脚本 (ProcessBuilder)
   ↓
5. Python脚本处理：
   - Pandas读取数据
   - NumPy计算统计指标
   - 生成分析结果
   ↓
6. 结果写入MySQL或返回JSON
   ↓
7. 前端展示分析报告和可视化图表
```

### 3.3 ETL数据处理流程

```
1. 定时任务触发 (Spring @Scheduled)
   ↓
2. 读取原始数据文件或数据库
   ↓
3. Hadoop处理 (MapReduce/Spark)
   - 数据清洗
   - 数据转换
   - 数据脱敏
   ↓
4. Python脚本二次处理
   - 数据验证
   - 格式标准化
   ↓
5. MyBatis批量插入MySQL
   ↓
6. 更新Redis缓存
   ↓
7. 记录处理日志
```

## 四、数据库设计

### 4.1 核心数据表（12张）

#### 1. 患者诊疗表 (patient_visit)
- 存储患者就诊记录
- 字段：患者ID（脱敏）、就诊时间、科室、诊断、费用等

#### 2. 科室运营表 (department_operation)
- 存储科室运营数据
- 字段：科室ID、日期、门诊量、收入、成本等

#### 3. 医保结算表 (insurance_settlement)
- 存储医保结算数据
- 字段：结算ID、患者ID（脱敏）、费用类型、报销金额等

#### 4. 设备使用表 (equipment_usage)
- 存储医疗设备使用情况
- 字段：设备ID、使用时间、使用率、维护记录等

#### 5. 药品库存表 (drug_inventory)
- 存储药品库存信息
- 字段：药品ID、库存量、进价、售价等

#### 6. 人员信息表 (staff_info)
- 存储医护人员信息
- 字段：员工ID、姓名、科室、职称等

#### 7-12. 其他主题表...
- 财务数据表
- 质量指标表
- 患者满意度表
- 资源分配表
- 绩效评估表
- 系统日志表

### 4.2 数据脱敏规则

- **患者身份证**：保留前6位和后4位，中间用*替代
- **患者姓名**：保留姓氏，名字用*替代
- **手机号**：保留前3位和后4位，中间用*替代

## 五、API设计

### 5.1 RESTful API规范

- **GET**：查询数据
- **POST**：创建数据
- **PUT**：更新数据
- **DELETE**：删除数据

### 5.2 18个核心API

#### 患者相关
1. `GET /api/patients` - 查询患者列表
2. `GET /api/patients/{id}` - 查询患者详情
3. `GET /api/patients/visits` - 查询就诊记录

#### 科室相关
4. `GET /api/departments` - 查询科室列表
5. `GET /api/departments/{id}/statistics` - 科室统计数据
6. `GET /api/departments/operation` - 科室运营数据

#### 医保相关
7. `GET /api/insurance/settlements` - 医保结算查询
8. `GET /api/insurance/statistics` - 医保统计分析
9. `GET /api/insurance/cost-control` - 医保控费分析

#### 统计分析
10. `GET /api/statistics/outpatient-trend` - 门诊量趋势
11. `GET /api/statistics/equipment-usage` - 设备使用率
12. `GET /api/statistics/resource-utilization` - 资源利用率

#### 分析报告
13. `POST /api/analysis/drg-report` - 生成DRG报告
14. `GET /api/analysis/reports` - 查询分析报告
15. `POST /api/analysis/resource-optimization` - 资源优化建议

#### 系统管理
16. `POST /api/auth/login` - 用户登录
17. `GET /api/users` - 用户管理
18. `GET /api/system/logs` - 系统日志

## 六、安全设计

### 6.1 权限分级

- **管理员**：所有权限
- **医生**：查看数据，生成报告
- **访客**：仅查看公开数据

### 6.2 安全措施

1. **JWT Token认证**：无状态认证
2. **接口权限控制**：基于角色的访问控制(RBAC)
3. **数据脱敏**：敏感信息自动脱敏
4. **SQL注入防护**：MyBatis参数化查询
5. **XSS防护**：前端输入验证
6. **HTTPS加密**：传输加密

## 七、性能优化

### 7.1 缓存策略

- **Redis缓存**：
  - 热点数据（科室列表、统计数据）
  - 缓存时间：5-30分钟
  - 缓存更新：数据变更时清除

### 7.2 数据库优化

- **索引优化**：关键字段建立索引
- **分页查询**：避免全表扫描
- **读写分离**：主从复制（可选）

### 7.3 前端优化

- **懒加载**：路由懒加载
- **组件缓存**：keep-alive
- **图表优化**：大数据量采样显示

## 八、部署架构

```
┌─────────────┐
│  Nginx      │  (反向代理、静态资源)
└──────┬──────┘
       │
┌──────┴──────┐
│  Vue前端     │  (静态文件)
└─────────────┘

┌─────────────┐
│  Spring Boot│  (后端服务，端口8080)
└──────┬──────┘
       │
┌──────┴──────┐
│  MySQL      │  (主数据库，端口3306)
└──────┬──────┘
       │
┌──────┴──────┐
│  Redis      │  (缓存，端口6379)
└─────────────┘

┌─────────────┐
│  Hadoop     │  (大数据处理，可选)
└─────────────┘
```

## 九、开发规范

### 9.1 代码规范

- **Java**：遵循阿里巴巴Java开发手册
- **Vue**：遵循Vue官方风格指南
- **SQL**：统一命名规范，添加注释

### 9.2 Git规范

- **分支**：master(生产)、develop(开发)、feature(功能)
- **提交**：feat(新功能)、fix(修复)、docs(文档)

### 9.3 接口文档

- 使用Swagger生成API文档
- 接口变更及时更新文档

